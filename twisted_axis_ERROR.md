**Twisted Axis / Mirror Error — Быстрая справка**

Кратко
- Проблема: полигоны выглядят повернутыми или зеркально отзеркаленными между этапами обработки (matplotlib / панорама).
- Причина: в разной части пайплайна используется разный порядок координат (``[x,y]`` vs ``[y,x]``) и/или применяются инверсии (``-x``/``-y``). Это даёт эффекты поворотов на 90°, 180° и зеркал.

Где чаще всего это происходит (порядок этапов)
1. Исходные GeoJSON (Росреестр): пары обычно в порядке ``[lon, lat]`` (EPSG:4326).
2. Режим преобразования в metrическую плоскость (EPSG:3857) → даёт ``(x_m, y_m)`` в метрах.
3. `stage1_make_polygon.py` — часто делает дополнительный `swap` или `mirror` перед записью в ``polygon.json`` (в нашем репо это опция ``APPLY_ROTATE_AND_MIRROR``):
   - пример: ``transformed = [[round(y,6), round(x,6)] for x,y in coords]`` — сохраняет как ``[y,x]``.
4. `make_krpano_grid_from_polygon.py`
   - если ожидает ``[x,y]`` (стандарт), но получает ``[y,x]``, то matplotlib (плоская карта) и панорама (сферическая проекция) будут давать разные ориентации.

Типичные симптомы
- Восток/Запад отражены (зеркально по X).
- Поворот 90° влево/вправо (оси перепутаны).
- Поворот 180° (двойная инверсия / swap + mirror).
- В одном окне (matplotlib) всё выглядит правильно, в другом (панорама) — нет.

Диагностика (быстро и точно)
1. Откройте ``polygon.json`` и посмотрите первые 4 координаты полигонов. Сравните с выводом ``stage1_make_polygon.py`` — есть ли там явный swap (в виде ``[y,x]``)?
2. Запустите контрольную проверку ориентации (вставьте в скрипт):

```
def orientation_test():
    for name, (x,y) in [("N",(0,100)), ("E",(100,0)), ("S",(0,-100)), ("W",(-100,0))]:
        ath, atv = project_point_to_panorama(x,y,CAMERA_HEIGHT)
        print(name, ath, atv)
```

   - Ожидаемое: для North azimuth около 0° (или другое, если у вас другая нулевая ориентация в панораме). Если North очутился в другом направлении, значит оси перепутаны/инвертированы.

3. В matplotlib постройте те же контрольные 4 точки и убедитесь, где они появляются (право/лево/верх/низ).

Как исправлять (рекомендации и best practices)
- Принцип: Нормализуйте один раз при входе и работайте дальше с единым «внутренним форматом» ``[x,y]``:
  1) Либо измените `stage1_make_polygon.py`, чтобы он сохранял ``[x,y]`` (рекомендую). Уберите ``APPLY_ROTATE_AND_MIRROR`` или измените логику записи.
  2) Либо (быстрая и безопасная опция) нормализуйте в `load_polygon()` сразу после чтения: замените сохранённый порядок (``[y,x]``) на ``[x,y]``:

```py
for item in items:
    ring = item.get("coordinates", [None])[0]
    if not ring:
        continue
    item["coordinates"][0] = [[pt[1], pt[0]] for pt in ring]
```

- После нормализации оставьте каноническую проекцию в ``project_point_to_panorama``:

```py
vx = x
vy = camera_height
vz = y
ath = degrees(atan2(vx, vz))
atv = degrees(asin(vy / r))
```

Пояснение: модель камеры — камера в (0,H,0), точка — (x,0,y). Это проверенная и стабильная формула для krpano-проектирования.

Предотвращение будущих ошибок
- Добавьте в репо небольшой тест‑скрипт `tools/orientation_check.py`, который выводит результаты N/E/S/W и сравнивает с ожидаемыми индексами.
- Документируйте в `stage1_make_polygon.py` чётко поведение `APPLY_ROTATE_AND_MIRROR` и предпочтительный внутренний формат (``[x,y]``).
- Писать небольшие unit-тесты, которые читают пример `polygon.json` и проверяют, что контрольные точки попадают в ожидаемые квадранты.

Короткая сводка команд для отладки

```bash
python -B make_krpano_grid_from_polygon.py   # запустить визуальную проверку и выбор центра
python -c "import json; print(json.load(open('polygon.json'))['data'][0]['coordinates'][:2])"  # посмотреть порядок пар
```

Если хотите, могу:
- добавить `orientation_check.py` в репо (включит N/E/S/W тесты и выдаст рекомендации),
- или изменить `stage1_make_polygon.py`, чтобы он записывал стандартный `[x,y]` и убрать `APPLY_ROTATE_AND_MIRROR`.

---
Файл создан как быстрый справочник — прикрепите его в PR или сохраните рядом с кодом, чтобы следующее поколение разработчиков не потратило часы на ту же проблему.

